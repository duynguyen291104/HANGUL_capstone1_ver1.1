<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Vocabulary Load</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .log { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #3b82f6; }
        .error { border-left-color: #ef4444; background: #fee; }
        .success { border-left-color: #22c55e; background: #efe; }
        button { padding: 10px 20px; margin: 5px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        pre { background: #f1f1f1; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug Vocabulary Loading</h1>
    
    <div>
        <button onclick="testAPI()">Test API Direct</button>
        <button onclick="testStore()">Test Zustand Store</button>
        <button onclick="clearCache()">Clear Browser Cache</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        async function testAPI() {
            log('üîÑ Testing API /api/vocabulary...');
            
            try {
                const response = await fetch('/api/vocabulary?limit=5');
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`‚úÖ API returned ${data.pagination.total} total items`, 'success');
                log(`Returned ${data.data.length} items in this request`, 'success');
                log(`<pre>${JSON.stringify(data.data[0], null, 2)}</pre>`);
                
                return data;
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testStore() {
            log('üîÑ Simulating Store Load (like useVocabularyStore)...');
            
            try {
                const response = await fetch('/api/vocabulary?limit=100000');
                
                if (response.ok) {
                    const result = await response.json();
                    const vocabulary = result.data || [];
                    
                    log(`‚úÖ API returned ${vocabulary.length} words`, 'success');
                    
                    if (vocabulary.length > 0) {
                        const vocabItems = vocabulary.map((item) => ({
                            id: item.id.toString(),
                            ko: item.ko,
                            vi: item.vi,
                            tags: item.tags || [],
                            stt: item.stt,
                            addedAt: item.addedAt ? new Date(item.addedAt).getTime() : Date.now(),
                            srsLevel: 0,
                            nextReview: Date.now(),
                            correctStreak: 0,
                            totalReviews: 0
                        }));
                        
                        log(`‚úÖ Parsed ${vocabItems.length} vocab items`, 'success');
                        log(`Sample item: ${vocabItems[0].ko} - ${vocabItems[0].vi}`, 'success');
                        
                        // Test IndexedDB
                        log('üíæ Testing IndexedDB...');
                        const dbName = 'TopikVocabDB';
                        const request = indexedDB.open(dbName);
                        
                        request.onsuccess = (event) => {
                            log('‚úÖ IndexedDB opened successfully', 'success');
                            const db = event.target.result;
                            log(`IndexedDB version: ${db.version}`);
                            log(`Object stores: ${Array.from(db.objectStoreNames).join(', ')}`);
                        };
                        
                        request.onerror = () => {
                            log('‚ùå IndexedDB failed to open', 'error');
                        };
                    }
                } else {
                    log(`‚ùå API returned status ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function clearCache() {
            log('üóëÔ∏è Clearing caches...');
            
            // Clear localStorage
            localStorage.clear();
            log('‚úÖ localStorage cleared');
            
            // Clear sessionStorage
            sessionStorage.clear();
            log('‚úÖ sessionStorage cleared');
            
            // Clear IndexedDB
            const dbDeleteRequest = indexedDB.deleteDatabase('TopikVocabDB');
            dbDeleteRequest.onsuccess = () => log('‚úÖ IndexedDB cleared', 'success');
            dbDeleteRequest.onerror = () => log('‚ùå Failed to clear IndexedDB', 'error');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Auto-run on load
        window.onload = () => {
            log('üöÄ Page loaded. Ready to debug!');
            log('Click "Test API Direct" to check if API works');
            log('Click "Test Store" to simulate vocabulary loading');
        };
    </script>
</body>
</html>
